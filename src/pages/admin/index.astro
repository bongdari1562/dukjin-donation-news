---
const title = "덕진노인복지관 후원소식 · 관리자";
---

<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{title}</title>
  </head>

  <body class="min-h-screen bg-zinc-50 text-zinc-900">
    <main class="mx-auto max-w-xl px-4 py-10">
      <h1 class="text-2xl font-semibold tracking-tight">관리자</h1>
      <p class="mt-2 text-sm text-zinc-600">비밀번호로 로그인 후 소식지를 등록합니다.</p>

      <!-- 로그인 -->
      <section id="loginBox" class="mt-8 rounded-2xl border border-zinc-200 bg-white p-5">
        <label class="block text-sm font-medium">관리자 비밀번호</label>
        <input id="pw" type="password" class="mt-2 w-full rounded-xl border border-zinc-200 px-3 py-2" placeholder="비밀번호 입력" />
        <button id="loginBtn" class="mt-3 w-full rounded-xl bg-zinc-900 px-4 py-2 text-white">
          로그인
        </button>
        <p id="loginMsg" class="mt-3 text-sm text-zinc-600"></p>
      </section>

      <!-- 등록 폼 -->
      <section id="formBox" class="mt-8 hidden rounded-2xl border border-zinc-200 bg-white p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">소식지 등록</h2>
          <button id="logoutBtn" class="text-sm text-zinc-600 hover:text-zinc-900">로그아웃</button>
        </div>

        <label class="mt-4 block text-sm font-medium">제목</label>
        <input id="title" class="mt-2 w-full rounded-xl border border-zinc-200 px-3 py-2" />

        <label class="mt-4 block text-sm font-medium">발행일</label>
        <input id="date" type="date" class="mt-2 w-full rounded-xl border border-zinc-200 px-3 py-2" />

        <label class="mt-4 block text-sm font-medium">요약</label>
        <textarea id="summary" rows="3" class="mt-2 w-full rounded-xl border border-zinc-200 px-3 py-2"></textarea>

        <label class="mt-4 block text-sm font-medium">썸네일 이미지 URL</label>
        <input id="thumbnail" class="mt-2 w-full rounded-xl border border-zinc-200 px-3 py-2" placeholder="https://..." />

        <label class="mt-4 block text-sm font-medium">이동 링크(URL)</label>
        <input id="url" class="mt-2 w-full rounded-xl border border-zinc-200 px-3 py-2" placeholder="https://..." />

        <button id="publishBtn" class="mt-5 w-full rounded-xl bg-zinc-900 px-4 py-2 text-white">
          등록(저장)
        </button>

        <p id="publishMsg" class="mt-3 text-sm text-zinc-600"></p>
      </section>
    </main>

    <script>
      const loginBox = document.getElementById("loginBox");
      const formBox = document.getElementById("formBox");
      const loginMsg = document.getElementById("loginMsg");
      const publishMsg = document.getElementById("publishMsg");

      function setToken(t) {
        localStorage.setItem("adminToken", t);
      }
      function getToken() {
        return localStorage.getItem("adminToken");
      }
      function clearToken() {
        localStorage.removeItem("adminToken");
      }

      async function checkExisting() {
        const token = getToken();
        if (!token) return;
        // 토큰 유효성 확인
        const r = await fetch("/.netlify/functions/auth", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ token }),
        });
        if (r.ok) {
          loginBox.classList.add("hidden");
          formBox.classList.remove("hidden");
        }
      }

      document.getElementById("loginBtn").addEventListener("click", async () => {
        loginMsg.textContent = "확인 중...";
        const password = document.getElementById("pw").value || "";
        const r = await fetch("/.netlify/functions/auth", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ password }),
        });
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          loginMsg.textContent = data?.error || "로그인 실패";
          return;
        }
        setToken(data.token);
        loginMsg.textContent = "로그인 성공!";
        loginBox.classList.add("hidden");
        formBox.classList.remove("hidden");
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        clearToken();
        formBox.classList.add("hidden");
        loginBox.classList.remove("hidden");
        loginMsg.textContent = "";
      });

      document.getElementById("publishBtn").addEventListener("click", async () => {
        publishMsg.textContent = "등록 중...";
        const token = getToken();
        const payload = {
          token,
          title: document.getElementById("title").value.trim(),
          date: document.getElementById("date").value,
          summary: document.getElementById("summary").value.trim(),
          thumbnail: document.getElementById("thumbnail").value.trim(),
          url: document.getElementById("url").value.trim(),
        };

        const r = await fetch("/.netlify/functions/publishNewsletter", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
          publishMsg.textContent = data?.error || "등록 실패";
          return;
        }
        publishMsg.textContent = "등록 완료! (Netlify가 자동 재배포 후 메인에 반영됩니다)";
      });

      checkExisting();
    </script>
  </body>
</html>
